<html>

<head>
  <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
  <meta content="utf-8" http-equiv="encoding">
  <script src="jquery.min.js"></script>
</head>

<body>
  <div>
    <img id="stream" src="stream.jpg" width="100%"></img>
    <button id="feed" style="width:400px;height:100px;margin-top:16px">Feed</button>
  </div>

  <div style="margin-top:32px;">
    <button id="shake" style="width:400px;height:100px;margin-top:16px">Shake</button>
    <button id="sound" style="width:400px;height:100px;margin-top:16px">Sound</button>
  </div>

  <div>
    <ul id="log"></ul>
  </div>
</body>

<script>

  // Streaming
  function updateStreamImage() {
    $("#stream").attr("src", "/stream.jpg?"+new Date().getTime());
  }
  function delayedUpdateStreamImage() {
    //setTimeout(updateStreamImage, 1000);
  }
  // When image has loaded, set timeout for getting next image
  $("#stream").on("load", delayedUpdateStreamImage);
  $("#stream").on("error", delayedUpdateStreamImage);


  const logItem = ({ time, message, href }) => (href !== undefined) ? 
  `<li>${time} <a href="${href}"><b>${message}</b></a> </li>` :
  `<li>${time} <b>${message}</b> </li>`;

  function updateLog() {
    $.ajax({
      type: "GET",
      url: "log",
      dataType: "json",
      success: data => {
        $("#log").html(data.reverse().map(logItem).join(''));
      }
    })
  }

  function execute(command) {
    console.log("Sending command:", command);
    $.ajax({
        type: "GET",
        url: command,
        dataType: "text",
        success: function(data) {
          console.log('Completed:', command);
          updateLog();
        }
     });
  }

  $("#feed").on("click", () => {
    // Disable button to prevent second click
    $("#feed").prop("disabled", true);
    execute('feed');
  });
  $("#shake").on("click", () => execute('shake'));
  $("#sound").on("click", () => execute('sound'));

  updateLog();

</script>

</html>
